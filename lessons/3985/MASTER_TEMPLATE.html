<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×™×›×•× ×©×™×¢×•×¨ ××§×“××™</title>
    
    <!-- Meta Tags -->
    <meta name='lesson-title' content=''>
    <meta name='lesson-date' content=''>
    <meta name='lesson-teacher' content=''>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDqxxf434N0wnn6C6AglEEIaqj5TVtoYLQ",
          authDomain: "memshalaa.firebaseapp.com",
          projectId: "memshalaa",
          storageBucket: "memshalaa.firebasestorage.app",
          messagingSenderId: "324187090365",
          appId: "1:324187090365:web:8e4956d0d1370b5aab36d4",
          measurementId: "G-2QHJF3SSJQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.display = 'block';
                if(document.getElementById('logoutButton')) document.getElementById('logoutButton').style.display = 'inline-flex';
                window.initMetaData();
            } else {
               // window.location.href = 'login.html'; 
               document.body.style.display = 'block'; 
               window.initMetaData();
            }
        });
        
        window.logout = function() { signOut(auth).then(() => { window.location.href = 'login.html'; }); }
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg: #f0f2f5; --surface: #ffffff; --text-main: #1c1e21; --text-sec: #606770;
            --primary: #1877f2; --accent: #e7f3ff; --border: #dadde1; --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --w: 800px;

            /* Colors */
            --hl-yellow-bg: #fff9c4; --hl-yellow-br: #fdd835;
            --hl-blue-bg: #e3f2fd; --hl-blue-br: #2196f3;
            --hl-green-bg: #e8f5e9; --hl-green-br: #4caf50; 
            --hl-red-bg: #ffebee; --hl-red-br: #ef5350;
        }

        body.dark-mode {
            --bg: #18191a; --surface: #242526; --text-main: #e4e6eb; --text-sec: #b0b3b8;
            --primary: #4599ff; --accent: #2d3f50; --border: #3e4042;
            --hl-yellow-bg: #423e22; --hl-blue-bg: #1e3a3e; --hl-green-bg: #1e3322; --hl-red-bg: #3e2121;
        }

        * { box-sizing: border-box; font-family: 'Rubik', sans-serif !important; }
        .fas, .far, .fab { font-family: "Font Awesome 6 Free" !important; } /* Fix Icons */
        
        body { background-color: var(--bg); color: var(--text-main); margin: 0; line-height: 1.6; font-size: 14px; display: none; }

        /* Header */
        header { background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; padding: 0.6rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header-content { max-width: var(--w); margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-content h1 { font-size: 1.1rem; margin: 0; display:flex; align-items:center; gap:10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .btn-action { background: var(--accent); border: none; border-radius: 50%; width: 34px; height: 34px; color: var(--primary); cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; margin-left: 5px; font-size: 14px; }
        .btn-action.active { background: var(--primary); color: white; }
        .btn-save-file { background: #4caf50; color: white; } 

        /* Tabs */
        .main-wrap { max-width: var(--w); margin: 20px auto; padding: 0 20px 80px; }
        .tabs { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; border-bottom: 2px solid var(--border); margin-bottom: 20px; padding-bottom: 5px;}
        .tab-link { background: none; border: none; padding: 8px 12px; font-size: 0.95rem; font-weight: 500; color: var(--text-sec); cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; margin-bottom: -7px; }
        .tab-link.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* Cards */
        .card { background: var(--surface); border-radius: 12px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; position: relative; min-height: 80px; }
        .highlight { padding: 15px; margin: 15px 0; border-radius: 8px; border-right: 4px solid transparent; position: relative; }
        
        .hl-example { background-color: var(--hl-yellow-bg); border-color: var(--hl-yellow-br); }
        .hl-external { background-color: var(--hl-blue-bg); border-color: var(--hl-blue-br); }
        .hl-success { background-color: var(--hl-green-bg); border-color: var(--hl-green-br); } 
        .hl-fail { background-color: var(--hl-red-bg); border-color: var(--hl-red-br); }

        h3 { border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px; font-size: 1.2rem; color: var(--text-main); }
        p, li { margin-bottom: 10px; line-height: 1.7; }

        /* Metadata Rows */
        .meta-row { display: flex; justify-content: flex-start; align-items: center; border-bottom: 1px dashed var(--border); padding: 10px 0; width: 100%; }
        .meta-label { font-weight: 700; color: var(--text-sec); margin-left: 15px; min-width: 60px; }
        .meta-value { font-weight: 400; color: var(--text-main); flex-grow: 1; text-align: right; outline: none; border-bottom: 1px solid transparent; min-height: 24px; }
        .meta-value:focus { border-bottom: 1px solid var(--primary); background: rgba(24,119,242,0.05); }
        input[type="date"] { border: none; background: transparent; color: var(--text-main); width: auto; flex-grow: 1; text-align: right; outline: none; }

        /* Tooltip / Term */
        .term { 
            color: var(--primary) !important; /* Force blue */
            font-weight: 700; cursor: help; 
            border-bottom: 1px dotted var(--primary); position: relative;
            display: inline-block;
        }
        .term:hover { background-color: rgba(24, 119, 242, 0.1); border-radius: 3px;}
        .term:hover::after {
            content: attr(data-def);
            position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 15px; border-radius: 8px;
            width: max-content; max-width: 300px; font-size: 13px; font-weight: 400;
            z-index: 99999; white-space: normal; line-height: 1.5; text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); pointer-events: none;
        }
        /* Arrow */
        .term:hover::before {
            content:''; position:absolute; bottom:115%; left:50%; margin-left:-6px;
            border-width:6px; border-style:solid; border-color:#333 transparent transparent transparent;
            z-index: 99999;
        }

        /* Accordion */
        details { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: visible; background: var(--surface); }
        summary { padding: 15px; cursor: pointer; font-weight: 700; font-size: 1.1rem; display: flex; justify-content: space-between; background: rgba(0,0,0,0.02); }
        .acc-body { padding: 15px; border-top: 1px solid var(--border); }

        /* --- Edit Mode Wrapper --- */
        .edit-wrapper { position: relative; margin-bottom: 8px; }
        body.editing-mode .edit-wrapper { border: 1px dashed rgba(0,0,0,0.15); padding-top: 40px; border-radius: 6px; background: rgba(255,255,255,0.3); }
        
        .wrapper-toolbar { display: none; position: absolute; top: 5px; right: 5px; gap: 5px; z-index: 100; direction: ltr; }
        body.editing-mode .wrapper-toolbar { display: flex; }

        .w-btn { width: 30px; height: 30px; background: #fff; border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.2s; }
        .w-btn:hover { transform: scale(1.1); background: var(--primary); color: white; border-color: var(--primary); }
        .w-btn.del:hover { background: #ef5350; border-color: #ef5350; }
        .w-btn.term { color: var(--primary); font-weight:bold; }
        
        .editable-content[contenteditable="true"] { outline: none; cursor: text; min-height: 1.2em; }

        /* --- Editor Modal --- */
        .fab-btn { position: fixed; bottom: 25px; left: 25px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; cursor: pointer; font-size: 26px; z-index: 2000; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
        .fab-btn:hover { transform: scale(1.1); }

        .editor-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
        .editor-box { background: var(--surface); padding: 25px; border-radius: 12px; width: 90%; height: 85%; max-width: 900px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); display: flex; flex-direction: column; cursor: default; }
        
        .type-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; flex-wrap: wrap; justify-content: center; }
        .type-btn { padding: 8px 16px; border: 1px solid var(--border); border-radius: 20px; cursor: pointer; font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; gap: 6px; background: var(--surface); color: var(--text-main); transition: 0.2s; }
        .type-btn.selected { box-shadow: 0 0 0 2px var(--primary); font-weight: 700; transform: translateY(-2px); }
        
        /* Colors */
        .btn-text.selected { background: #eee; border-color: #999; }
        .btn-acc.selected { background: #333; color: #fff; border-color: #000; }
        .btn-ext { background: var(--hl-blue-bg); border-color: var(--hl-blue-br); color: #005c69; }
        .btn-ex { background: var(--hl-yellow-bg); border-color: var(--hl-yellow-br); color: #5f4c00; }
        .btn-per { background: var(--hl-green-bg); border-color: var(--hl-green-br); color: #1b5e20; }
        .btn-task { background: var(--hl-red-bg); border-color: var(--hl-red-br); color: #b71c1c; }

        #editorTitleInput { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 6px; font-weight: bold; background: var(--bg); color: var(--text-main); }
        .editor-toolbar { display: flex; gap: 8px; margin-bottom: 5px; background: #f9f9f9; padding: 8px; border-radius: 6px; flex-wrap: wrap; }
        .tb-btn { padding: 5px 10px; background: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        
        .rich-editor { flex: 1; border: 1px solid var(--border); border-radius: 6px; padding: 15px; overflow-y: auto; background: var(--bg); font-size: 16px; color: var(--text-main); user-select: text !important; -webkit-user-select: text !important; outline: none; cursor: text; }
        .rich-editor:empty:before { content: '×”×§×œ×“ ×›××Ÿ...'; color: #999; }
        
        .modal-actions { margin-top: 15px; display: flex; justify-content: space-between; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 1rem;}
        .btn-cancel { background: transparent; color: var(--text-sec); border: 1px solid var(--border); padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 1rem;}

        body.placing-mode { cursor: crosshair; }
        body.placing-mode .card, body.placing-mode .acc-body, body.placing-mode .content-zone { outline: 2px dashed var(--primary); min-height: 80px; }
        body.placing-mode *:hover { box-shadow: inset 0 0 0 1000px rgba(24,119,242,0.1); z-index: 3000; }

        @media print { header, .tabs, .fab-btn, .editor-overlay, .wrapper-toolbar { display: none !important; } body { display: block !important; font-size: 12px; } body.editing-mode { border: none !important; padding: 0 !important; } .edit-wrapper { border: none !important; padding: 0 !important; margin: 0 !important; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <div class="brand">
                <h1><i class="fas fa-graduation-cap"></i> <span id="header-title-text">×˜×•×¢×Ÿ ×›×•×ª×¨×ª...</span></h1>
            </div>
            <div class="actions">
                <button class="btn-action btn-save-file" onclick="downloadSource()" title="×©××•×¨ ×§×•×‘×¥ HTML"><i class="fas fa-save"></i></button>
                <button class="btn-action" id="editToggleBtn" onclick="toggleEditMode()" title="××¦×‘ ×¢×¨×™×›×”"><i class="fas fa-pen"></i></button>
                <button class="btn-action" id="theme-toggle" title="×™×•×/×œ×™×œ×”"><i class="fas fa-moon"></i></button>
                <button class="btn-action" onclick="window.print()" title="×”×“×¤×¡/PDF"><i class="fas fa-print"></i></button>
                <button class="btn-action" id="logoutButton" onclick="logout()" style="display:none;" title="×™×¦×™××”"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
    </header>

    <div class="main-wrap">
        <nav class="tabs">
            <button class="tab-link active" onclick="switchTab('overview', this)">×¡×§×™×¨×”</button>
            <button class="tab-link" onclick="switchTab('content', this)">×ª×•×›×Ÿ</button>
            <button class="tab-link" onclick="switchTab('qa', this)">×©××œ×•×ª</button>
            <button class="tab-link" onclick="switchTab('glossary', this)">××•× ×—×™× ×•××§×•×¨×•×ª</button>
            <button class="tab-link" onclick="switchTab('tasks', this)">××˜×œ×•×ª</button>
        </nav>

        <!-- 1. OVERVIEW -->
        <div id="overview" class="tab-content active">
            <div class="card" id="meta-card">
                <h3>×¤×¨×˜×™ ×”×©×™×¢×•×¨</h3>
                <div class="meta-row">
                    <div class="meta-label">× ×•×©×:</div>
                    <div id="meta-subject" class="meta-value" contenteditable="false"></div>
                </div>
                <div class="meta-row">
                    <div class="meta-label">××¨×¦×”:</div>
                    <div id="meta-value-teacher" class="meta-value" contenteditable="false"></div>
                </div>
                <div class="meta-row">
                    <div class="meta-label">×ª××¨×™×š:</div>
                    <input type="date" id="meta-value-date" class="meta-value" disabled>
                </div>
            </div>
            <div class="card">
                <h3>×ª×§×¦×™×¨</h3>
                <div id="summary-text" class="content-zone"></div>
            </div>
        </div>

        <!-- 2. CONTENT -->
        <div id="content" class="tab-content content-zone"></div>

        <!-- 3. QA -->
        <div id="qa" class="tab-content">
            <div class="card">
                <h3>×©××œ×•×ª ×•×“×™×•×Ÿ</h3>
                <div id="qa-body" class="content-zone"></div>
            </div>
        </div>

        <!-- 4. GLOSSARY & SOURCES -->
        <div id="glossary" class="tab-content">
            <div class="card">
                <h3>××•× ×—×™× ×•×”×’×“×¨×•×ª</h3>
                <ol class="glossary-list content-zone" id="glossary-list"></ol>
            </div>
            <div class="card">
                <h3>××§×•×¨×•×ª ×—×™×¦×•× ×™×™×</h3>
                <ul id="sources-list" class="content-zone"></ul>
            </div>
        </div>

        <!-- 5. TASKS -->
        <div id="tasks" class="tab-content">
            <div class="card hl-fail">
                <h3>××˜×œ×•×ª</h3>
                <div id="tasks-body" class="content-zone"></div>
            </div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab-btn" onclick="openEditor()"><i class="fas fa-plus"></i></button>

    <!-- Editor -->
    <div class="editor-overlay" id="editorModal">
        <!-- Fix: Independent click handling to allow input focus -->
        <div class="editor-box" id="editorBox">
            <h3 style="text-align:center;border:none;margin-bottom:10px;">×”×•×¡×¤×ª ×ª×•×›×Ÿ</h3>
            
            <div class="type-scroll">
                <button class="type-btn btn-text selected" onclick="setType(this, 'text')">×˜×§×¡×˜ ×¨×’×™×œ</button>
                <button class="type-btn btn-acc" onclick="setType(this, 'accordion')"><i class="fas fa-list"></i> × ×•×©× ×—×“×©</button>
                <button class="type-btn btn-ext" onclick="setType(this, 'external')">×”×¨×—×‘×”</button>
                <button class="type-btn btn-ex" onclick="setType(this, 'example')">×“×•×’××”</button>
                <button class="type-btn btn-per" onclick="setType(this, 'personal')">×”×¢×¨×” ××™×©×™×ª</button>
                <button class="type-btn btn-task" onclick="setType(this, 'task')">××˜×œ×”</button>
            </div>

            <input type="text" id="editorTitleInput" placeholder="×›×•×ª×¨×ª..." style="display:none;">

            <div class="editor-toolbar">
                <button class="tb-btn" onmousedown="event.preventDefault(); execCmd('bold')"><b>B</b></button>
                <button class="tb-btn" onmousedown="event.preventDefault(); execCmd('italic')"><i>I</i></button>
                <button class="tb-btn" onmousedown="event.preventDefault(); execCmd('underline')"><u>U</u></button>
                <button class="tb-btn" onmousedown="event.preventDefault(); execCmd('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
                <button class="tb-btn" onmousedown="event.preventDefault(); execCmd('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                
                <div style="width:1px;background:#ccc;margin:0 5px;"></div>
                
                <button class="tb-btn" onmousedown="event.preventDefault(); execCmd('fontSize', '5')">T+</button>
                <button class="tb-btn" onmousedown="event.preventDefault(); execCmd('fontSize', '3')">T-</button>
                <input type="color" onchange="execCmd('foreColor', this.value)" title="×¦×‘×¢ ×˜×§×¡×˜" style="width:25px;height:25px;border:none;background:none;cursor:pointer;">
                
                <div style="width:1px;background:#ccc;margin:0 5px;"></div>
                <!-- Fix: Prevent focus loss on createTerm -->
                <button class="tb-btn" onmousedown="event.preventDefault(); createTermFromEditor()" title="×¦×•×¨ ××•× ×—" style="color:var(--primary);"><i class="fas fa-book"></i> ××•× ×—</button>
            </div>

            <div id="richEditor" class="rich-editor" contenteditable="true"></div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeEditor()">×‘×™×˜×•×œ</button>
                <button class="btn-save" onclick="startPlacement()">×‘×—×¨ ××™×§×•×</button>
            </div>
        </div>
    </div>

    <script>
        let isEditMode = false;
        let contentType = 'text';
        let pendingHTML = '';
        let isDirty = false;

        window.onbeforeunload = function() { if (isDirty) return "×©×™× ×•×™×™× ×œ× × ×©××¨×•"; };
        function markDirty() { isDirty = true; }

        // Init Meta
        window.initMetaData = function() {
            const mTitle = document.querySelector("meta[name='lesson-title']").content;
            const mTeacher = document.querySelector("meta[name='lesson-teacher']").content;
            const mDate = document.querySelector("meta[name='lesson-date']").content;

            const subEl = document.getElementById('meta-subject');
            const teachEl = document.getElementById('meta-value-teacher');
            const dateEl = document.getElementById('meta-value-date');

            if(subEl && !subEl.innerText) subEl.innerText = mTitle;
            if(teachEl && !teachEl.innerText) teachEl.innerText = mTeacher;
            if(dateEl && !dateEl.value) dateEl.value = mDate;

            updateHeader();

            subEl.addEventListener('input', () => { 
                markDirty(); 
                updateHeader(); 
                document.querySelector("meta[name='lesson-title']").setAttribute("content", subEl.innerText);
            });
            teachEl.addEventListener('input', () => { 
                markDirty(); 
                document.querySelector("meta[name='lesson-teacher']").setAttribute("content", teachEl.innerText);
            });
            dateEl.addEventListener('change', () => { 
                markDirty();
                document.querySelector("meta[name='lesson-date']").setAttribute("content", dateEl.value);
            });
        };

        function updateHeader() {
            const val = document.getElementById('meta-subject').innerText;
            document.getElementById('header-title-text').innerText = val || '×¡×™×›×•× ×©×™×¢×•×¨';
            document.title = val || '×¡×™×›×•× ×©×™×¢×•×¨';
        }

        // --- GLOSSARY TOOL ---
        function addTermToTab(text, def) {
            const list = document.getElementById('glossary-list');
            const li = document.createElement('li');
            const content = `<strong>${text}:</strong> ${def}`;
            
            // If editing, wrap immediately
            if (isEditMode) {
                 const wrapper = createWrapper(content);
                 li.appendChild(wrapper);
            } else {
                 li.innerHTML = content;
            }
            list.appendChild(li);
            markDirty();
        }

        window.createTerm = function() {
            const sel = window.getSelection();
            if (!sel.rangeCount || !sel.toString().trim()) return alert('×¡××Ÿ ××™×œ×” ×‘×˜×§×¡×˜');
            const text = sel.toString();
            const def = prompt("×”×’×“×¨×” ×¢×‘×•×¨: " + text);
            if (def) {
                document.execCommand('insertHTML', false, `<span class="term" data-def="${def}">${text}</span>`);
                addTermToTab(text, def);
            }
        }
        window.createTermFromEditor = function() { window.createTerm(); }

        // --- WRAPPER ENGINE ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('editToggleBtn');
            
            if(isEditMode) {
                document.body.classList.add('editing-mode');
                btn.classList.add('active');
                
                // Meta
                document.getElementById('meta-subject').setAttribute('contenteditable', 'true');
                document.getElementById('meta-value-teacher').setAttribute('contenteditable', 'true');
                document.getElementById('meta-value-date').removeAttribute('disabled');
                
                // Wrap all content zones
                document.querySelectorAll('.content-zone, .acc-body').forEach(zone => wrapChildren(zone));

            } else {
                document.body.classList.remove('editing-mode');
                btn.classList.remove('active');
                
                document.querySelectorAll('[contenteditable]').forEach(el => el.setAttribute('contenteditable', 'false'));
                document.getElementById('meta-value-date').setAttribute('disabled', 'true');
                updateHeader();
            }
        }

        function wrapChildren(container) {
            Array.from(container.children).forEach(child => {
                if(child.classList.contains('edit-wrapper') || child.tagName === 'BR') return;
                
                // Lists special handling
                if(container.tagName === 'OL' || container.tagName === 'UL') {
                     const wrapper = createWrapper(child.innerHTML);
                     child.innerHTML = '';
                     child.appendChild(wrapper);
                } else {
                    const wrapper = createWrapper(child.cloneNode(true));
                    container.replaceChild(wrapper, child);
                }
            });
        }

        function createWrapper(innerContent) {
            const wrapper = document.createElement('div');
            wrapper.className = 'edit-wrapper';
            
            const controls = document.createElement('div');
            controls.className = 'wrapper-toolbar';
            controls.contentEditable = "false";
            controls.innerHTML = `
                <div class="w-btn" onclick="moveBlock(this,-1)">â–²</div>
                <div class="w-btn" onclick="moveBlock(this,1)">â–¼</div>
                <div class="w-btn term" onmousedown="event.preventDefault(); termFromRow(this)">ğŸ“–</div>
                <div class="w-btn del" onclick="deleteBlock(this)">âœ–</div>
            `;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'editable-content';
            contentDiv.setAttribute('contenteditable', 'true');
            contentDiv.addEventListener('input', markDirty);
            
            if(typeof innerContent === 'string') contentDiv.innerHTML = innerContent;
            else contentDiv.appendChild(innerContent);

            wrapper.appendChild(controls);
            wrapper.appendChild(contentDiv);
            return wrapper;
        }

        window.moveBlock = function(btn, dir) {
            let block = btn.closest('.edit-wrapper');
            if(block.parentElement.tagName === 'LI') block = block.parentElement;
            
            markDirty();
            if(dir===-1 && block.previousElementSibling) block.parentNode.insertBefore(block, block.previousElementSibling);
            if(dir===1 && block.nextElementSibling) block.parentNode.insertBefore(block.nextElementSibling, block);
        }
        window.deleteBlock = function(btn) {
            if(confirm('×œ××—×•×§?')) { 
                markDirty(); 
                let block = btn.closest('.edit-wrapper');
                if(block.parentElement.tagName === 'LI') block.parentElement.remove();
                else block.remove(); 
            }
        }
        window.termFromRow = function(btn) {
            const parent = btn.closest('.edit-wrapper').querySelector('.editable-content');
            parent.focus(); 
            window.createTerm();
        }

        // --- EDITOR MODAL LOGIC (FIXED) ---
        
        // Prevent closing when clicking inside
        document.getElementById('editorBox').addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // Close when clicking outside
        document.getElementById('editorModal').addEventListener('click', function(e) {
            if(e.target.id === 'editorModal') closeEditor();
        });

        function openEditor() { 
            document.getElementById('editorModal').style.display = 'flex'; 
            // Explicitly clear and focus
            document.getElementById('richEditor').innerHTML = '';
            document.getElementById('editorTitleInput').value = '';
            
            setTimeout(()=> {
                document.getElementById('richEditor').focus();
            }, 50); 
        }
        
        function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }
        function execCmd(cmd, val=null) { document.execCommand(cmd, false, val); }

        function setType(btn, type) {
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            contentType = type;
            const tInp = document.getElementById('editorTitleInput');
            tInp.style.display = (type !== 'text') ? 'block' : 'none';
            if(type==='accordion') tInp.placeholder = '×›×•×ª×¨×ª × ×•×©×...';
            else tInp.placeholder = '×›×•×ª×¨×ª...';
        }

        function startPlacement() {
            const html = document.getElementById('richEditor').innerHTML;
            const title = document.getElementById('editorTitleInput').value;

            if(!html && contentType !== 'accordion') return alert('×”×›× ×¡ ×ª×•×›×Ÿ');

            let inner = '';
            if(contentType === 'accordion') {
                inner = `<details open><summary>${title || '× ×•×©×'}</summary><div class="acc-body content-zone">${html}</div></details>`;
            } else {
                let blockContent = '';
                if(contentType==='text') blockContent = `<p>${html}</p>`;
                else if(contentType==='external') blockContent = `<div class="highlight hl-external"><h4><i class="fas fa-book"></i> ${title||'×”×¨×—×‘×”'}</h4><div>${html}</div></div>`;
                else if(contentType==='example') blockContent = `<div class="highlight hl-example"><p><strong>${title||'×“×•×’××”'}:</strong></p><div>${html}</div></div>`;
                else if(contentType==='personal') blockContent = `<div class="highlight hl-success"><h4><i class="fas fa-sticky-note"></i> ${title||'×”×¢×¨×” ××™×©×™×ª'}</h4><div>${html}</div></div>`;
                else if(contentType==='task') blockContent = `<div class="highlight hl-fail"><h4>${title||'××˜×œ×”'}</h4><div>${html}</div></div>`;
                inner = blockContent;
            }
            
            pendingHTML = inner;

            document.getElementById('editorModal').style.display = 'none';
            document.body.classList.add('placing-mode');
            
            const t = document.createElement('div');
            t.innerText = "×œ×—×¥ ×›×“×™ ×œ××§×";
            t.style.cssText = "position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px;border-radius:20px;z-index:4000;";
            document.body.appendChild(t);
            setTimeout(()=>t.remove(), 3000);
            
            document.addEventListener('click', placeHandler, true);
        }

        function placeHandler(e) {
            e.preventDefault(); e.stopPropagation();
            markDirty();

            let target = e.target.closest('.edit-wrapper, details, li, p, .highlight'); 
            let container = e.target.closest('.content-zone, .acc-body');

            let node = document.createElement('div');
            node.innerHTML = pendingHTML;
            let newEl = node.firstElementChild;

            if(isEditMode) {
                if(contentType === 'accordion') {
                   // Just insert
                } else {
                   newEl = createWrapper(newEl);
                }
            }

            if(target && target.parentElement.closest('.content-zone')) {
                target.insertAdjacentElement('afterend', newEl);
            } else if(container) {
                container.appendChild(newEl);
            } else {
                document.getElementById('content').appendChild(newEl);
            }

            document.body.classList.remove('placing-mode');
            document.removeEventListener('click', placeHandler, true);
            
            if(isEditMode) { toggleEditMode(); toggleEditMode(); } 
        }

        // General
        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content, .tab-link').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }
        document.getElementById('theme-toggle').addEventListener('click', ()=>document.body.classList.toggle('dark-mode'));

        function downloadSource() {
            if(isEditMode) toggleEditMode();
            isDirty=false;
            const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = (document.title||'lesson')+'.html';
            a.click();
        }

        if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', window.initMetaData); else window.initMetaData();
    </script>
</body>
</html>